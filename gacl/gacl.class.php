<?php if(!defined('ADODB_DIR')){define('ADODB_DIR',dirname(__FILE__).'/../vendor/adodb/adodb-php');}require_once(dirname(__FILE__)."/../library/sqlconf.php");require_once(dirname(__FILE__)."/../vendor/adodb/adodb-php/adodb.inc.php");require_once(dirname(__FILE__)."/../vendor/adodb/adodb-php/drivers/adodb-mysqli.inc.php");require_once(dirname(__FILE__)."/../library/ADODB_mysqli_mod.php");class gacl{public$config_file='';public$_debug=false;public$_db_table_prefix='gacl_';public$_db_type='mysqli_mod';public$_db_host='';public$_db_user='';public$_db_password='';public$_db_name='';public$_db='';public$_db_utf8_flag='';public$_caching=false;public$_force_cache_expire=true;public$_cache_dir='/tmp/phpgacl_cache';public$_cache_expire_time=600;public$_group_switch='_group_';function __construct($options=null){$available_options=array('db','debug','items_per_page','max_select_box_items','max_search_return_items','db_table_prefix','db_type','db_host','db_user','db_password','db_name','caching','force_cache_expire','cache_dir','cache_expire_time');if(file_exists($this->config_file)){$config=parse_ini_file($this->config_file);if(is_array($config)){$gacl_options=array_merge($config,$options);}unset($config);}if(is_array($options)){foreach($options as$key=>$value){$this->debug_text("Option: ".$key);if(in_array($key,$available_options)){$this->debug_text("Valid Config options: ".$key);$property='_'.$key;$this->$property=$value;}else{$this->debug_text("ERROR: Config option: ".$key." is not a valid option");}}}global $sqlconf,$disable_utf8_flag;$this->_db_host=$sqlconf["host"];$this->_db_user=$sqlconf["login"];$this->_db_password=$sqlconf["pass"];$this->_db_name=$sqlconf["dbase"];if(!$disable_utf8_flag){$utf8_flag=true;}else{$utf8_flag=false;}$this->_db_utf8_flag=$utf8_flag;require_once(ADODB_DIR.'/adodb.inc.php');require_once(ADODB_DIR.'/adodb-pager.inc.php');if(is_object($this->_db)){$this->db=&$this->_db;}else{$this->db=ADONewConnection($this->_db_type);$this->db->SetFetchMode(ADODB_FETCH_NUM);if(file_exists($GLOBALS['OE_SITE_DIR']."/documents/certificates/mysql-ca")){if(defined('MYSQLI_CLIENT_SSL')){$this->db->clientFlags=MYSQLI_CLIENT_SSL;}}$this->db->port=$sqlconf["port"];$this->db->PConnect($this->_db_host,$this->_db_user,$this->_db_password,$this->_db_name);if($this->_db_utf8_flag){$success_flag=$this->db->Execute("SET NAMES 'utf8'");if(!$success_flag){error_log("PHP custom error: from gacl gacl/gacl.class.php  - Unable to set up UTF8 encoding with mysql database".$this->db->ErrorMsg(),0);}}$sql_strict_set_success=$this->db->Execute("SET sql_mode = ''");if(!$sql_strict_set_success){error_log("Unable to set strict sql setting: ".$this->db->ErrorMsg(),0);}if($GLOBALS['debug_ssl_mysql_connection']){error_log("CHECK SSL CIPHER IN GACL ADODB: ".print_r($this->db->Execute("SHOW STATUS LIKE 'Ssl_cipher';")->fields,true));}}$this->db->debug=$this->_debug;if($this->_caching==true){if(!class_exists('Hashed_Cache_Lite')){require_once(dirname(__FILE__).'/Cache_Lite/Hashed_Cache_Lite.php');}$cache_options=array('caching'=>$this->_caching,'cacheDir'=>$this->_cache_dir.'/','lifeTime'=>$this->_cache_expire_time,'fileLocking'=>true,'writeControl'=>false,'readControl'=>false,'memoryCaching'=>true,'automaticSerialization'=>false);$this->Cache_Lite=new Hashed_Cache_Lite($cache_options);}return true;}function debug_text($text){if($this->_debug){echo$text."<br>\n";}return true;}function debug_db($function_name=''){if($function_name!=''){$function_name.=' (): ';}return$this->debug_text($function_name.'database error: '.$this->db->ErrorMsg().' ('.$this->db->ErrorNo().')');}function acl_check($aco_section_value,$aco_value,$aro_section_value,$aro_value,$axo_section_value=null,$axo_value=null,$root_aro_group=null,$root_axo_group=null){$acl_result=$this->acl_query($aco_section_value,$aco_value,$aro_section_value,$aro_value,$axo_section_value,$axo_value,$root_aro_group,$root_axo_group);return$acl_result['allow'];}function acl_return_value($aco_section_value,$aco_value,$aro_section_value,$aro_value,$axo_section_value=null,$axo_value=null,$root_aro_group=null,$root_axo_group=null){$acl_result=$this->acl_query($aco_section_value,$aco_value,$aro_section_value,$aro_value,$axo_section_value,$axo_value,$root_aro_group,$root_axo_group);return$acl_result['return_value'];}function acl_check_array($aco_section_value,$aco_value,$aro_array){if(!is_array($aro_array)){$this->debug_text("acl_query_array(): ARO Array must be passed");return false;}foreach($aro_array as$aro_section_value=>$aro_value_array){foreach($aro_value_array as$aro_value){$this->debug_text("acl_query_array(): ARO Section Value: ".$aro_section_value." ARO VALUE: ".$aro_value);if($this->acl_check($aco_section_value,$aco_value,$aro_section_value,$aro_value)){$this->debug_text("acl_query_array(): ACL_CHECK True");$retarr[$aro_section_value][]=$aro_value;}else{$this->debug_text("acl_query_array(): ACL_CHECK False");}}}return$retarr;}function acl_query($aco_section_value,$aco_value,$aro_section_value,$aro_value,$axo_section_value=null,$axo_value=null,$root_aro_group=null,$root_axo_group=null,$debug=null,$return_all=false){$cache_id='acl_query_'.$aco_section_value.'-'.$aco_value.'-'.$aro_section_value.'-'.$aro_value.'-'.$axo_section_value.'-'.$axo_value.'-'.$root_aro_group.'-'.$root_axo_group.'-'.$debug.'-'.$return_all;$retarr=$this->get_cache($cache_id);if(!$retarr){$aro_group_ids=$this->acl_get_groups($aro_section_value,$aro_value,$root_aro_group,'ARO');if(is_array($aro_group_ids) AND !empty($aro_group_ids)){$sql_aro_group_ids=implode(',',$aro_group_ids);}if($axo_section_value!='' AND $axo_value!=''){$axo_group_ids=$this->acl_get_groups($axo_section_value,$axo_value,$root_axo_group,'AXO');if(is_array($axo_group_ids) AND !empty($axo_group_ids)){$sql_axo_group_ids=implode(',',$axo_group_ids);}}$order_by=array();$query='
					SELECT		a.id,a.allow,a.return_value
					FROM		'.$this->_db_table_prefix.'acl a
					LEFT JOIN 	'.$this->_db_table_prefix.'aco_map ac ON ac.acl_id=a.id';if($aro_section_value!=$this->_group_switch){$query.='
					LEFT JOIN	'.$this->_db_table_prefix.'aro_map ar ON ar.acl_id=a.id';}if($axo_section_value!=$this->_group_switch){$query.='
					LEFT JOIN	'.$this->_db_table_prefix.'axo_map ax ON ax.acl_id=a.id';}if(isset($sql_aro_group_ids)){$query.='
					LEFT JOIN	'.$this->_db_table_prefix.'aro_groups_map arg ON arg.acl_id=a.id
					LEFT JOIN	'.$this->_db_table_prefix.'aro_groups rg ON rg.id=arg.group_id';}$query.='
					LEFT JOIN	'.$this->_db_table_prefix.'axo_groups_map axg ON axg.acl_id=a.id';if(isset($sql_axo_group_ids)){$query.='
					LEFT JOIN	'.$this->_db_table_prefix.'axo_groups xg ON xg.id=axg.group_id';}$query.='
					WHERE		a.enabled=1
						AND		(ac.section_value='.$this->db->quote($aco_section_value).' AND ac.value='.$this->db->quote($aco_value).')';if($aro_section_value==$this->_group_switch){if(!isset($sql_aro_group_ids)){$this->debug_text('acl_query(): Invalid ARO Group: '.$aro_value);return false;}$query.='
						AND		rg.id IN ('.$sql_aro_group_ids.')';$order_by[]='(rg.rgt-rg.lft) ASC';}else{$query.='
						AND		((ar.section_value='.$this->db->quote($aro_section_value).' AND ar.value='.$this->db->quote($aro_value).')';if(isset($sql_aro_group_ids)){$query.=' OR rg.id IN ('.$sql_aro_group_ids.')';$order_by[]='(CASE WHEN ar.value IS NULL THEN 0 ELSE 1 END) DESC';$order_by[]='(rg.rgt-rg.lft) ASC';}$query.=')';}if($axo_section_value==$this->_group_switch){if(!isset($sql_axo_group_ids)){$this->debug_text('acl_query(): Invalid AXO Group: '.$axo_value);return false;}$query.='
						AND		xg.id IN ('.$sql_axo_group_ids.')';$order_by[]='(xg.rgt-xg.lft) ASC';}else{$query.='
						AND		(';if($axo_section_value=='' AND $axo_value==''){$query.='(ax.section_value IS NULL AND ax.value IS NULL)';}else{$query.='(ax.section_value='.$this->db->quote($axo_section_value).' AND ax.value='.$this->db->quote($axo_value).')';}if(isset($sql_axo_group_ids)){$query.=' OR xg.id IN ('.$sql_axo_group_ids.')';$order_by[]='(CASE WHEN ax.value IS NULL THEN 0 ELSE 1 END) DESC';$order_by[]='(xg.rgt-xg.lft) ASC';}else{$query.=' AND axg.group_id IS NULL';}$query.=')';}$order_by[]='a.updated_date DESC';$query.='
					ORDER BY	'.implode(',',$order_by).'
					';if($return_all){$rs=$this->db->Execute($query);}else{$rs=$this->db->SelectLimit($query,1);}if(!is_object($rs)){$this->debug_db('acl_query');return false;}if($return_all){while($arr=$rs->FetchRow()){$row[]=$arr;}}else{$row=$rs->FetchRow();}if(isset($row)&&is_array($row)){if($return_all){foreach($row as$single_row){$allow=false;if(isset($single_row[1]) AND $single_row[1]==1){$allow=true;}$retarr[]=array('acl_id'=>&$single_row[0],'return_value'=>&$single_row[2],'allow'=>$allow);}}else{$allow=false;if(isset($row[1]) AND $row[1]==1){$allow=true;}$retarr=array('acl_id'=>&$row[0],'return_value'=>&$row[2],'allow'=>$allow);}}else{if($return_all){$retarr[]=array('acl_id'=>null,'return_value'=>null,'allow'=>false);}else{$retarr=array('acl_id'=>null,'return_value'=>null,'allow'=>false);}}if($debug==true){$retarr['query']=&$query;}$this->put_cache($retarr,$cache_id);}if($return_all){$this->debug_text("<b>acl_query():</b> ACO Section: ".$aco_section_value." ACO Value: ".$aco_value." ARO Section: ".$aro_section_value." ARO Value ".$aro_value." ACL ID: OMITTED due to return_all");}else{$this->debug_text("<b>acl_query():</b> ACO Section: ".$aco_section_value." ACO Value: ".$aco_value." ARO Section: ".$aro_section_value." ARO Value ".$aro_value." ACL ID: ".$retarr['acl_id'].' Result: '.$retarr['allow']);}return$retarr;}function acl_get_groups($section_value,$value,$root_group=null,$group_type='ARO'){switch(strtolower($group_type)){case 'axo':$group_type='axo';$object_table=$this->_db_table_prefix.'axo';$group_table=$this->_db_table_prefix.'axo_groups';$group_map_table=$this->_db_table_prefix.'groups_axo_map';break;default:$group_type='aro';$object_table=$this->_db_table_prefix.'aro';$group_table=$this->_db_table_prefix.'aro_groups';$group_map_table=$this->_db_table_prefix.'groups_aro_map';break;}$cache_id='acl_get_groups_'.$section_value.'-'.$value.'-'.$root_group.'-'.$group_type;$retarr=$this->get_cache($cache_id);if(!$retarr){$query='
					SELECT 		DISTINCT g2.id';if($section_value==$this->_group_switch){$query.='
					FROM		'.$group_table.' g1,'.$group_table.' g2';$where='
					WHERE		g1.value='.$this->db->quote($value);}else{$query.='
					FROM		'.$object_table.' o,'.$group_map_table.' gm,'.$group_table.' g1,'.$group_table.' g2';$where='
					WHERE		(o.section_value='.$this->db->quote($section_value).' AND o.value='.$this->db->quote($value).')
						AND		gm.'.$group_type.'_id=o.id
						AND		g1.id=gm.group_id';}if($root_group!=''){$query.=','.$group_table.' g3';$where.='
						AND		g3.value='.$this->db->quote($root_group).'
						AND		((g2.lft BETWEEN g3.lft AND g1.lft) AND (g2.rgt BETWEEN g1.rgt AND g3.rgt))';}else{$where.='
						AND		(g2.lft <= g1.lft AND g2.rgt >= g1.rgt)';}$query.=$where;$rs=$this->db->Execute($query);if(!is_object($rs)){$this->debug_db('acl_get_groups');return false;}$retarr=array();while(!$rs->EOF){$retarr[]=reset($rs->fields);$rs->MoveNext();}$this->put_cache($retarr,$cache_id);}return$retarr;}function get_cache($cache_id){if($this->_caching==true){$this->debug_text("get_cache(): on ID: ".$cache_id);if(is_string($this->Cache_Lite->get($cache_id))){return unserialize($this->Cache_Lite->get($cache_id));}}return false;}function put_cache($data,$cache_id){if($this->_caching==true){$this->debug_text("put_cache(): Cache MISS on ID: ".$cache_id);return$this->Cache_Lite->save(serialize($data),$cache_id);}return false;}};