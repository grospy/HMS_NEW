<?php require_once(dirname(__FILE__,3)."/library/allow_cronjobs.php");;$backpic="";$current_dir=dirname($_SERVER['SCRIPT_FILENAME']);chdir($current_dir);require_once("../../interface/globals.php");require_once($srcdir."/maviq_phone_api.php");$facilityService=new \OpenEMR\Services\FacilityService();$type="Phone";$before_trigger_hours=72;$before_trigger_hours=$GLOBALS['phone_notification_hour'];$phone_url=$GLOBALS['phone_gateway_url'];$phone_id=$GLOBALS['phone_gateway_username'];$phone_token=$GLOBALS['phone_gateway_password'];$phone_time_range=$GLOBALS['phone_time_range'];$facilities=cron_getFacilitiesMap();$fac_phone_map=$facilities['phone_map'];$fac_msg_map=$facilities['msg_map'];$db_patient=cron_getPhoneAlertpatientData($type,$before_trigger_hours);echo"<br>".xlt("Total Records Found").": ".count($db_patient);$client=new MaviqClient($phone_id,$phone_token,$phone_url);for($p=0;$p<count($db_patient);$p++){$prow=$db_patient[$p];$p_date=$prow['pc_eventDate'];$pieces=explode("-",$p_date);$appt_date=date("m/d/Y",mktime(0,0,0,$pieces[1],$pieces[2],$pieces[0]));$appt_time=$prow['pc_startTime'];$greeting=$fac_msg_map[$prow['pc_facility']];if($greeting==null){$greeting=$GLOBALS['phone_appt_message']['Default'];}$data=array("firstName"=>$prow['fname'],"lastName"=>$prow['lname'],"phone"=>$prow['phone_home'],"apptDate"=>$appt_date,"apptTime"=>$appt_time,"doctor"=>$prow['pc_aid'],"greeting"=>$greeting,"timeRange"=>$phone_time_range,"type"=>"appointment","timeZone"=>date('P'),"callerId"=>$fac_phone_map[$prow['pc_facility']]);$response=$client->sendRequest("appointment","POST",$data);if($response->IsError){$strMsg="Error starting phone call for ".$prow['fname']." | ".$prow['lname']." | ".$prow['phone_home']." | ".$appt_date." | ".$appt_time." | ".$response->ErrorMessage."\n";}else{$strMsg="\n========================".$type." || ".date("Y-m-d H:i:s")."=========================";$strMsg.="\nPhone reminder sent successfully: ".$prow['fname']." | ".$prow['lname']." |	| ".$prow['phone_home']." | ".$appt_date." | ".$appt_time." ";cron_InsertNotificationLogEntry($prow,$greeting,$phone_url);cron_updateentry($type,$prow['pid'],$prow['pc_eid']);}WriteLog($strMsg);}sqlClose();function cron_updateentry($type,$pid,$pc_eid){$query="update openemr_postcalendar_events set ";if($type=='SMS'){$query.=" pc_sendalertsms='YES' ";}elseif($type=='Email'){$query.=" pc_sendalertemail='YES' ";}elseif($type=='Phone'){$query.=" pc_sendalertsms='YES' ";}$query.=" where pc_pid=? and pc_eid=? ";$db_sql=(sqlStatement($query,array($pid,$pc_eid)));}function cron_getPhoneAlertpatientData($type,$trigger_hours){if($type=='Phone'){$ssql=" and pd.hipaa_voice='YES' and pd.phone_home<>''	and ope.pc_sendalertsms='NO' and ope.pc_apptstatus != '*' ";$check_date=date("Y-m-d",mktime(date("H")+$trigger_hours,0,0,date("m"),date("d"),date("Y")));}$patient_field="pd.pid,pd.title,pd.fname,pd.lname,pd.mname,pd.phone_cell,pd.email,pd.hipaa_allowsms,pd.hipaa_allowemail,pd.phone_home,pd.hipaa_voice,";$ssql.=" and (ope.pc_eventDate=?)";$query="select ".$patient_field." pd.pid,ope.pc_eid,ope.pc_pid,ope.pc_title,
			ope.pc_hometext,ope.pc_eventDate,ope.pc_endDate,
			ope.pc_duration,ope.pc_alldayevent,ope.pc_startTime,ope.pc_endTime,ope.pc_facility
		from
			openemr_postcalendar_events as ope ,patient_data as pd
		where
			ope.pc_pid=pd.pid ".$ssql."
		order by
			ope.pc_eventDate,ope.pc_endDate,pd.pid";$db_patient=(sqlStatement($query,array($check_date)));$patient_array=array();$cnt=0;while($prow=sqlFetchArray($db_patient)){$patient_array[$cnt]=$prow;$cnt++;}return$patient_array;}function cron_InsertNotificationLogEntry($prow,$phone_msg,$phone_gateway){$patient_info=$prow['title']." ".$prow['fname']." ".$prow['mname']." ".$prow['lname']."|||".$prow['phone_home'];$message=$phone_msg;$sql_loginsert="INSERT INTO `notification_log` ( `iLogId` , `pid` , `pc_eid` , `message`, `type` , `patient_info` , `smsgateway_info` , `pc_eventDate` , `pc_endDate` , `pc_startTime` , `pc_endTime` , `dSentDateTime` ) VALUES ";$sql_loginsert.="(NULL , ?, ?, ?, 'Phone', ?, ?, ?, ?, ?, ?, ?)";$db_loginsert=(sqlStatement($sql_loginsert,array($prow[pid],$prow[pc_eid],$message,$patient_info,$phone_gateway,$prow[pc_eventDate],$prow[pc_endDate],$prow[pc_startTime],$prow[pc_endTime],date("Y-m-d H:i:s"))));}function WriteLog($data){$log_file=$GLOBALS['phone_reminder_log_dir'];if($log_file!=null){$filename=$log_file."/"."phone_reminder_cronlog_".date("Ymd").".html";if(!$fp=fopen($filename,'a')){print"Cannot open file (".$filename.")";}else{$sdata="\n====================================================================\n";if(!fwrite($fp,$data.$sdata)){print"Cannot write to file (".$filename.")";}fclose($fp);}}}function cron_getFacilitiesMap(){global $facilityService;$message_map=$GLOBALS['phone_appt_message'];$facility_msg_map=array();$facility_phone_map=array();$facilities=$facilityService->getAll();foreach($facilities as$prow){$facility_msg_map[$prow['id']]=$message_map[$prow['name']];$facility_phone_map[$prow['id']]=$prow['phone'];}$facility_map=array('msg_map'=>$facility_msg_map,'phone_map'=>$facility_phone_map);return$facility_map;}