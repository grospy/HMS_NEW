<?php require_once(dirname(__FILE__)."/../common/compatibility/Checker.php");;;;$response=\OpenEMR\Common\Checker::checkPhpVersion();if($response!==true){die($response);}$GLOBALS['debug_ssl_mysql_connection']=false;if(!isset($ignoreAuth)){$ignoreAuth=false;}if(!isset($ignoreAuth_offsite_portal)){$ignoreAuth_offsite_portal=false;}if(!isset($ignoreAuth_onsite_portal_two)){$ignoreAuth_onsite_portal_two=false;}if(!defined('IS_WINDOWS')){define('IS_WINDOWS',(stripos(PHP_OS,'WIN')===0));}ini_set('session.gc_maxlifetime','14400');$webserver_root=dirname(dirname(__FILE__));if(IS_WINDOWS){$webserver_root=str_replace("\\","/",$webserver_root);}$server_document_root=realpath($_SERVER['DOCUMENT_ROOT']);if(IS_WINDOWS){$server_document_root=str_replace("\\","/",$server_document_root);}$web_root=substr($webserver_root,strspn($webserver_root^$server_document_root,"\0"));if(preg_match("/^[^\/]/",$web_root)){$web_root="/".$web_root;}$GLOBALS['OE_SITES_BASE']=$webserver_root."/sites";ini_set('session.cookie_path',$web_root?$web_root:'/');session_name("HMS");session_start();if(empty($_SESSION['site_id'])||!empty($_GET['site'])){if(!empty($_GET['site'])){$tmp=$_GET['site'];}else{if(empty($ignoreAuth)){die("Site ID is missing from session data!");}$tmp=$_SERVER['HTTP_HOST'];if(!is_dir($GLOBALS['OE_SITES_BASE']."/".$tmp)){$tmp="default";}}if(empty($tmp)||preg_match('/[^A-Za-z0-9\\-.]/',$tmp)){die("Site ID '".htmlspecialchars($tmp,ENT_NOQUOTES)."' contains invalid characters.");}if(isset($_SESSION['site_id'])&&($_SESSION['site_id']!=$tmp)){session_unset();if(isset($landingpage)&&!empty($landingpage)){header('Location: index.php?site='.$tmp);}else{header('Location: ../login/login.php?site='.$tmp);}exit;}if(!isset($_SESSION['site_id'])||$_SESSION['site_id']!=$tmp){$_SESSION['site_id']=$tmp;}}$GLOBALS['OE_SITE_DIR']=$GLOBALS['OE_SITES_BASE']."/".$_SESSION['site_id'];$GLOBALS['OE_SITE_WEBROOT']=$web_root."/sites/".$_SESSION['site_id'];require_once($GLOBALS['OE_SITE_DIR']."/config.php");require_once(dirname(__FILE__)."/../library/sqlconf.php");if(!$disable_utf8_flag){ini_set('default_charset','utf-8');$HTML_CHARSET="UTF-8";mb_internal_encoding('UTF-8');}else{ini_set('default_charset','iso-8859-1');$HTML_CHARSET="ISO-8859-1";mb_internal_encoding('ISO-8859-1');}$GLOBALS['rootdir']=$web_root."/interface";$rootdir=$GLOBALS['rootdir'];$GLOBALS['srcdir']=$webserver_root."/library";$GLOBALS['fileroot']=(''.$webserver_root);$include_root=$webserver_root."/interface";$GLOBALS['webroot']=$web_root;$GLOBALS['assets_static_relative']=$web_root."/public/assets";$GLOBALS['images_static_relative']=$web_root."/public/images";$GLOBALS['images_static_absolute']=$webserver_root."/public/images";$GLOBALS['vendor_dir']=$webserver_root."/vendor";$GLOBALS['fonts_dir']=$web_root."/public/fonts";$GLOBALS['template_dir']=$GLOBALS['fileroot']."/templates/";$GLOBALS['incdir']=$include_root;$GLOBALS['login_screen']=$GLOBALS['rootdir']."/login_screen.php";$GLOBALS['edi_271_file_path']=$GLOBALS['OE_SITE_DIR']."/edi/";if(is_dir($GLOBALS['OE_SITE_DIR'].'/documents/mpdf/')){if(!is_dir($GLOBALS['OE_SITE_DIR'].'/documents/mpdf/ttfontdata/')){mkdir($GLOBALS['OE_SITE_DIR'].'/documents/mpdf/ttfontdata/',0755);}if(!is_dir($GLOBALS['OE_SITE_DIR'].'/documents/mpdf/pdf_tmp/')){mkdir($GLOBALS['OE_SITE_DIR'].'/documents/mpdf/pdf_tmp/',0755);}}else{mkdir($GLOBALS['OE_SITE_DIR'].'/documents/mpdf/ttfontdata/',0755,true);mkdir($GLOBALS['OE_SITE_DIR'].'/documents/mpdf/pdf_tmp/',0755);}define("_MPDF_TEMP_PATH",$GLOBALS['OE_SITE_DIR'].'/documents/mpdf/pdf_tmp/');define("_MPDF_TTFONTDATAPATH",$GLOBALS['OE_SITE_DIR'].'/documents/mpdf/ttfontdata/');require_once $GLOBALS['vendor_dir']."/autoload.php";if(file_exists($webserver_root."/.env")){$dotenv=new \Dotenv\Dotenv($webserver_root);$dotenv->load();}$twigOptions=['debug'=>false,];$twigLoader=new Twig_Loader_Filesystem();$twigEnv=new Twig_Environment($twigLoader,$twigOptions);if(array_key_exists('debug',$twigOptions)&&$twigOptions['debug']==true){$twigEnv->addExtension(new Twig_Extension_Debug());}$twigEnv->addGlobal('assets_dir',$GLOBALS['assets_static_relative']);$twigEnv->addGlobal('srcdir',$GLOBALS['srcdir']);$twigEnv->addGlobal('rootdir',$GLOBALS['rootdir']);$twigEnv->addFilter(new Twig_SimpleFilter('translate',function($string){return xl($string);}));$GLOBALS['twigLoader']=$twigLoader;$GLOBALS['twig']=$twigEnv;require_once(dirname(__FILE__)."/../library/sql.inc");require_once(dirname(__FILE__)."/../version.php");$GLOBALS["log_level"]="OFF";try{$GLOBALS["kernel"]=new \OpenEMR\Core\Kernel();}catch(\Exception$e){error_log($e->getMessage());die();}$GLOBALS["doctrine_connection_pooling"]=true;$GLOBALS['weight_loss_clinic']=false;$GLOBALS['ippf_specific']=false;$GLOBALS['inhouse_pharmacy']=false;$GLOBALS['sell_non_drug_products']=0;$glrow=sqlQuery("SHOW TABLES LIKE 'globals'");if(!empty($glrow)){$gl_user=array();$temp_authuserid='';if(!empty($_SESSION['authUserID'])){$temp_authuserid=$_SESSION['authUserID'];}else{if(!empty($_POST['authUser'])){$temp_sql_ret=sqlQuery("SELECT `id` FROM `users` WHERE `username` = ?",array($_POST['authUser']));if(!empty($temp_sql_ret['id'])){$temp_authuserid=$temp_sql_ret['id'];}}}if(!empty($temp_authuserid)){$glres_user=sqlStatement("SELECT `setting_label`, `setting_value` "."FROM `user_settings` "."WHERE `setting_user` = ? "."AND `setting_label` LIKE 'global:%'",array($temp_authuserid));for($iter=0;$row=sqlFetchArray($glres_user);$iter++){$row['setting_label']=substr($row['setting_label'],7);$gl_user[$iter]=$row;}}$GLOBALS['language_menu_show']=array();$glres=sqlStatement("SELECT gl_name, gl_index, gl_value FROM globals "."ORDER BY gl_name, gl_index");while($glrow=sqlFetchArray($glres)){$gl_name=$glrow['gl_name'];$gl_value=$glrow['gl_value'];if(!empty($gl_user)){foreach($gl_user as$setting){if($gl_name==$setting['setting_label']){$gl_value=$setting['setting_value'];}}}if($gl_name=='language_menu_other'){$GLOBALS['language_menu_show'][]=$gl_value;}elseif($gl_name=='css_header'){$GLOBALS[$gl_name]=$rootdir.'/themes/'.attr($gl_value).'?v='.$v_js_includes;$temp_css_theme_name=$gl_value;}elseif($gl_name=='weekend_days'){$GLOBALS[$gl_name]=explode(',',$gl_value);}elseif($gl_name=='specific_application'){if($gl_value=='2'){$GLOBALS['ippf_specific']=true;}elseif($gl_value=='3'){$GLOBALS['weight_loss_clinic']=true;}}elseif($gl_name=='inhouse_pharmacy'){if($gl_value){$GLOBALS['inhouse_pharmacy']=true;}if($gl_value=='2'){$GLOBALS['sell_non_drug_products']=1;}elseif($gl_value=='3'){$GLOBALS['sell_non_drug_products']=2;}}elseif($gl_name=='gbl_time_zone'){if($gl_value){date_default_timezone_set($gl_value);}sqlStatement("SET time_zone = ?",array((new DateTime())->format("P")));}else{$GLOBALS[$gl_name]=$gl_value;}}$GLOBALS['language_menu_login']=false;if((count($GLOBALS['language_menu_show'])>=1)||$GLOBALS['language_menu_showall']){$GLOBALS['language_menu_login']=true;}$GLOBALS['concurrent_layout']=3;$rtl_override=false;if(isset($_SESSION['language_direction'])){if($_SESSION['language_direction']=='rtl'&&!strpos($GLOBALS['css_header'],'rtl')){$rtl_override=true;}}elseif(isset($_SESSION['language_choice'])){$_SESSION['language_direction']=getLanguageDir($_SESSION['language_choice']);if($_SESSION['language_direction']=='rtl'&&!strpos($GLOBALS['css_header'],'rtl')){$rtl_override=true;}}else{$default_lang_id=sqlQuery('SELECT lang_id FROM lang_languages WHERE lang_description = ?',array($GLOBALS['language_default']));if(getLanguageDir($default_lang_id['lang_id'])==='rtl'&&!strpos($GLOBALS['css_header'],'rtl')){$rtl_override=true;}}if($rtl_override){$new_theme='rtl_'.$temp_css_theme_name;if(file_exists($include_root.'/themes/'.$new_theme)){$GLOBALS['css_header']=$rootdir.'/themes/'.attr($new_theme).'?v='.$v_js_includes;}else{error_log("Missing theme file ".text($include_root).'/themes/'.text($new_theme));}}unset($temp_css_theme_name,$new_theme,$rtl_override);}else{$GLOBALS['language_menu_login']=true;$GLOBALS['language_menu_showall']=true;$GLOBALS['language_menu_show']=array('English (Standard)','Swedish');$GLOBALS['language_default']="English (Standard)";$GLOBALS['translate_layout']=true;$GLOBALS['translate_lists']=true;$GLOBALS['translate_gacl_groups']=true;$GLOBALS['translate_form_titles']=true;$GLOBALS['translate_document_categories']=true;$GLOBALS['translate_appt_categories']=true;$timeout=7200;$openemr_name='HMS';$css_header=$rootdir."/themes/style_default.css";$GLOBALS['css_header']=$css_header;$GLOBALS['schedule_start']=8;$GLOBALS['schedule_end']=17;$GLOBALS['calendar_interval']=15;$GLOBALS['phone_country_code']='1';$GLOBALS['disable_non_default_groups']=true;$GLOBALS['ippf_specific']=false;}$GLOBALS['restore_sessions']=1;$top_bg_line=' bgcolor="#dddddd" ';$GLOBALS['style']['BGCOLOR2']="#dddddd";$bottom_bg_line=$top_bg_line;$title_bg_line=' bgcolor="#bbbbbb" ';$nav_bg_line=' bgcolor="#94d6e7" ';$login_filler_line=' bgcolor="#f7f0d5" ';$logocode="<img class='img-responsive center-block' src='".$GLOBALS['OE_SITE_WEBROOT']."/images/login_logo.gif'>";$tinylogocode1="<img class='tinylogopng' src='".$GLOBALS['OE_SITE_WEBROOT']."/images/logo_1.png'>";$tinylogocode2="<img class='tinylogopng' src='".$GLOBALS['OE_SITE_WEBROOT']."/images/logo_2.png'>";$linepic=$rootdir."/pic/repeat_vline9.gif";$table_bg=' bgcolor="#cccccc" ';$GLOBALS['style']['BGCOLOR1']="#cccccc";$GLOBALS['style']['TEXTCOLOR11']="#222222";$GLOBALS['style']['HIGHLIGHTCOLOR']="#dddddd";$GLOBALS['style']['BOTTOM_BG_LINE']=$bottom_bg_line;$GLOBALS['logoBarHeight']=110;$GLOBALS['navBarHeight']=22;$GLOBALS['titleBarHeight']=50;$tmore=xl('(More)');$tback=xl('(Back)');if(!empty($special_timeout)){$timeout=intval($special_timeout);}$versionService=new \OpenEMR\Services\VersionService();$version=$versionService->fetch();if(!empty($version)){$patch_appending="";$version_getrealpatch=$version->getRealPatch();if(($version->getRealPatch()!='0')&&(!(empty($version_getrealpatch)))){$patch_appending=" (".$version->getRealPatch().")";}$openemr_version=$version->getMajor().".".$version->getMinor().".".$version->getPatch();$openemr_version.=$version->getTag().$patch_appending;}else{$openemr_version=xl('Unknown version');}$srcdir=$GLOBALS['srcdir'];$login_screen=$GLOBALS['login_screen'];$GLOBALS['css_header']=$css_header;$GLOBALS['backpic']=$backpic;$GLOBALS['Emergency_Login_email']=empty($GLOBALS['Emergency_Login_email_id'])?0:1;$GLOBALS['include_de_identification']=0;if(($ignoreAuth_offsite_portal===true)&&($GLOBALS['portal_offsite_enable']==1)){$ignoreAuth=true;}elseif(($ignoreAuth_onsite_portal_two===true)&&($GLOBALS['portal_onsite_two_enable']==1)){$ignoreAuth=true;}if(!$ignoreAuth){include_once($srcdir."/auth.inc");}$GLOBALS['layout_search_color']='#ff9919';$SMTP_Auth=!empty($GLOBALS['SMTP_USER']);$GLOBALS['baseModDir']="interface/modules/";$GLOBALS['customModDir']="custom_modules";$GLOBALS['zendModDir']="zend_modules";$encounter=empty($_SESSION['encounter'])?0:$_SESSION['encounter'];if(!empty($_GET['pid'])&&empty($_SESSION['pid'])){$_SESSION['pid']=$_GET['pid'];}elseif(!empty($_POST['pid'])&&empty($_SESSION['pid'])){$_SESSION['pid']=$_POST['pid'];}$pid=empty($_SESSION['pid'])?0:$_SESSION['pid'];$userauthorized=empty($_SESSION['userauthorized'])?0:$_SESSION['userauthorized'];$groupname=empty($_SESSION['authProvider'])?0:$_SESSION['authProvider'];$attendant_type=(empty($pid)&&isset($_SESSION['therapy_group']))?'gid':'pid';$therapy_group=(empty($pid)&&isset($_SESSION['therapy_group']))?$_SESSION['therapy_group']:0;function strterm($string,$length){if(strlen($string)>=($length-3)){return substr($string,0,$length-3)."...";}else{return$string;}}if(version_compare(phpversion(),"5.2.1",">=")){$GLOBALS['temporary_files_dir']=rtrim(sys_get_temp_dir(),'/');}ini_set("session.bug_compat_warn","off");